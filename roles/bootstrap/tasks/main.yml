---
- name: Bootstrap ansible-bootstrap-epel Yum repo 
  copy: src=ansible-bootstrap-epel.repo
        dest=/etc/yum.repos.d/ansible-bootstrap-epel.repo
        owner=root
        group=root
        mode=0644

- name: Epel-release install
  yum: name=epel-release
       enablerepo=ansible-bootstrap-epel
       state=present

- name: Epel repository enable
  ini_file: dest=/etc/yum.repos.d/epel.repo
            section=epel
            option=enabled
            value=1

- name: Install bootstrap packages
  yum: name="{{ item }}"
       state=installed
  with_items:
    - collectd
    - fail2ban
    - ferm
    - git
    - git-core
    - htop
    - iftop
    - java-1.7.0-openjdk
    - logwatch
    - monit
    - postfix
    - python-keyczar
    - screen
    - vim
    - zsh

- name: Establish MOTD
  template: src=motd
            dest=/etc/motd
            owner=root
            group=root
            mode=0644

- name: Create Monit state directories
  file: path=/var/lib/monit
        owner=root
        group=root
        mode=0700
        state=directory

- name: Establish monit.conf
  template: src=monit.conf
            dest=/etc/monit.conf
            owner=root
            group=root
            mode=0600
  notify:
    - Restart monit

- name: Add sshd monit config
  template: src=sshd.monit
            dest=/etc/monit.d/sshd.conf
            owner=root
            group=root
            mode=0644
  notify:
    - Reload monit

- name: Ensure monit service is running
  service: name=monit
           state=started
           enabled=yes

- name: Enable iptables service is running
  service: name=iptables
           state=started
           enabled=yes

- name: Add ferm conf directory
  file: path=/etc/ferm
        owner=root
        group=root
        mode=0700
        state=directory

- name: Set iptables configuration
  template: src=ferm.conf
            dest=/etc/ferm/ferm.conf
            owner=root
            group=root
            mode=0644
  notify:
    - Reload iptables configuration

- name: Add fail2ban monit config
  template: src=fail2ban.monit
            dest=/etc/monit.d/fail2ban.conf
            owner=root
            group=root
            mode=0644
  notify:
    - Reload monit

- name: Start fail2ban service
  service: name=fail2ban
           state=started
           enabled=yes

- name: Create initial user
  user: name="{{ base_user }}"
        password="{{ base_user_password }}"
        shell=/bin/zsh

- name: Create initial user's .ssh directory
  file: path=/home/{{ base_user }}/.ssh
        owner="{{ base_user }}"
        group="{{ base_user }}"
        mode=0700
        state=directory

- name: Add authorized_keys to initial user's directory
  copy: src=authorized_keys
        dest=/home/{{ base_user }}/.ssh/authorized_keys
        owner="{{ base_user }}"
        group="{{ base_user }}"
        mode=0600

- name: make SSHD configuration sane
  template: src=sshd_config
            dest=/etc/ssh/sshd_config
            owner=root
            group=root
            mode=0600
  notify:
    - Restart sshd monit

- name: Clone oh-my-zsh repo for initial user
  remote_user: "{{ base_user }}"
  git: repo=git://github.com/robbyrussell/oh-my-zsh.git
       dest=/home/{{ base_user }}/.oh-my-zsh

- name: Deploy .zshrc
  template: src=zshrc
            dest=/home/{{ base_user }}/.zshrc
            owner="{{ base_user }}"
            group="{{ base_user }}"

- name: Configure sudoers to allow for sudoable user
  lineinfile: dest=/etc/sudoers
              backup=yes
              state=present
              regexp="^%{{ base_user }}"
              insertafter="^# %wheel"
              line="%{{ base_user }} ALL=(ALL) ALL"

- name: Add postfix monit config
  template: src=postfix.monit
            dest=/etc/monit.d/postfix.conf
            owner=root
            group=root
            mode=0644
  notify:
    - Reload monit

- name: Ensure postfix service running
  service: name=postfix
           state=started
           enabled=yes

- name: Configure daily logwatch e-mails
  lineinfile: dest=/etc/cron.daily/0logwatch
              regexp="^    logwatch"
              line="    logwatch --output mail --mailto {{ logwatch_email }} --detail high"
              state=present
              create=yes

- name: Sets up performant sysctl settings
  sysctl: name="{{ item.name }}"
          value="{{ item.value }}"
          state=present
  with_items:
    - { name: 'net.ipv4.ip_local_port_range', value: '2000 65000' }
    - { name: 'net.ipv4.tcp_window_scaling', value: '1' }
    - { name: 'net.ipv4.tcp_max_syn_backlog', value: '3240000' }
    - { name: 'net.core.somaxconn', value: '65535' }
    - { name: 'net.ipv4.tcp_max_tw_buckets', value: '1440000' }
    - { name: 'net.core.rmem_default', value: '8388608' }
    - { name: 'net.core.rmem_max', value: '16777216' }
    - { name: 'net.core.wmem_max', value: '16777216' }
    - { name: 'net.ipv4.tcp_rmem', value: '4096 87380 16777216' }
    - { name: 'net.ipv4.tcp_wmem', value: '4096 87380 16777216' }
    - { name: 'net.ipv4.tcp_congestion_control', value: 'cubic' }

- name: Make the default screenrc suck less
  template: src=screenrc
            dest=/etc/screenrc
            owner=root
            group=root
            mode=0644
