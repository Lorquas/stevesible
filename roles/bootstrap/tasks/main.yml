---
- name: Bootstrap ansible-bootstrap-epel Yum repository
  copy:
    src: ansible-bootstrap-epel.repo
    dest: /etc/yum.repos.d/ansible-bootstrap-epel.repo
    owner: root
    group: root
    mode: 0644

- name: Install epel-release package using bootstrap repository
  yum:
    name: epel-release
    enablerepo: ansible-bootstrap-epel
    state: present

- name: Enable official EPEL repository
  ini_file:
    dest: /etc/yum.repos.d/epel.repo
    section: epel
    option: enabled
    value: 1

- name: Install bootstrap packages
  yum:
    name: "{{ item }}"
    state: installed
  with_items:
    - collectd
    - fail2ban
    - ferm
    - git
    - git-core
    - htop
    - iftop
    - java-1.7.0-openjdk
    - logwatch
    - postfix
    - python-keyczar
    - screen
    - vim
    - zsh

- include: ../../monit/tasks/main.yml

- name: Establish MOTD
  template:
    src: motd.j2
    dest: /etc/motd
    owner: root
    group: root
    mode: 0644

- name: Add sshd monit config
  template:
    src: sshd.monit.j2
    dest: /etc/monit.d/sshd.conf
    owner: root
    group: root
    mode: 0644
  notify:
    - Reload monit

- name: Enable iptables service is running
  service:
    name: iptables
    state: started
    enabled: yes

- name: Add ferm conf directory
  file:
    path: /etc/ferm
    owner: root
    group: root
    mode: 0700
    state: directory

- name: Set iptables configuration
  template:
    src: ferm.conf.j2
    dest: /etc/ferm/ferm.conf
    owner: root
    group: root
    mode: 0644
  notify:
    - Reload iptables configuration

- name: Add fail2ban monit config
  template:
    src: fail2ban.monit.j2
    dest: /etc/monit.d/fail2ban.conf
    owner: root
    group: root
    mode: 0644
  notify:
    - Reload monit

- name: Start fail2ban service
  service:
    name: fail2ban
    state: started
    enabled: yes

- name: Create initial user
  user:
    name: "{{ base_user }}"
    password: "{{ base_user_password }}"
    shell: /bin/zsh

- name: Create initial user's .ssh directory
  file:
    path: /home/{{ base_user }}/.ssh
    owner: "{{ base_user }}"
    group: "{{ base_user }}"
    mode: 0700
    state: directory

- name: Add authorized_keys to initial user's directory
  template:
    src: authorized_keys.j2
    dest: "/home/{{ base_user }}/.ssh/authorized_keys"
    owner: "{{ base_user }}"
    group: "{{ base_group }}"
    mode: 0600

- name: Make SSHD configuration sane
  template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: 0600
  notify:
    - Restart sshd monit

- name: Clone oh-my-zsh repo for initial user
  remote_user: "{{ base_user }}"
  git:
    repo: git://github.com/robbyrussell/oh-my-zsh.git
    dest: "/home/{{ base_user }}/.oh-my-zsh"

- name: Deploy .zshrc
  template:
    src: zshrc.j2
    dest: "/home/{{ base_user }}/.zshrc"
    owner: "{{ base_user }}"
    group: "{{ base_group }}"

- name: Configure sudoers to allow for sudoable user
  lineinfile:
    dest: /etc/sudoers
    backup: yes
    state: present
    regexp: "^%{{ base_user }}"
    insertafter: "^# %wheel"
    line: "%{{ base_user }} ALL=(ALL) ALL"

- name: Add Postfix monit config
  template:
    src: postfix.monit.j2
    dest: /etc/monit.d/postfix.conf
    owner: root
    group: root
    mode: 0644
  notify:
    - Reload monit

- name: Ensure Postfix service running
  service:
    name: postfix
    state: started
    enabled: yes

- name: Configure daily logwatch e-mails
  lineinfile:
    dest: /etc/cron.daily/0logwatch
    regexp: "^    logwatch"
    line: "    logwatch --output mail --mailto {{ logwatch_email }} --detail high"
    state: present
    create: yes

- name: Make the default screenrc suck less
  template:
    src: screenrc.j2
    dest: /etc/screenrc
    owner: root
    group: root
    mode: 0644
