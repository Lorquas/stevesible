---
- name: Workaround ansible_lsb bug by re-running setup module
  setup:
  tags:
    - thermos

- name: Ensure that Thermos directories exist
  file:
    path: "{{ item }}"
    state: directory
    recurse: yes
  with_items:
    - "{{ thermos_bin_dir }}/{{ thermos_version }}"
    - "{{ thermos_state_dir }}/{{ thermos_observer_root_path }}"
    - "{{ thermos_log_dir }}"
  tags:
    - thermos

- name: Download Thermos binaries
  get_url:
    url: "{{ thermos_mirror_base }}/{{ thermos_version }}/thermos/mesos-{{ mesos_version }}/{{ ansible_os_family }}/{{ ansible_lsb.major_release }}/{{ item }}.pex"
    dest: "{{ thermos_bin_dir }}/{{ thermos_version }}/{{ item }}"
  with_items:
    - gc_executor
    - thermos_executor
    - thermos_observer
    - thermos_runner
  tags:
    - thermos

- name: Ensure that Thermos binaries are executable
  file:
    path: "{{ thermos_bin_dir }}/{{ thermos_version }}/{{ item }}"
    mode: 0755
  with_items:
    - gc_executor
    - thermos_executor
    - thermos_observer
    - thermos_runner
  tags:
    - thermos

- include: observer.yml
  when: "'observer' in thermos_roles"
