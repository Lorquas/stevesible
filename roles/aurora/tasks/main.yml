---
- name: Ensure that cluster name is an a templatable state
  set_fact:
    safe_aurora_cluster_name: "{{ aurora_cluster_name | regex_replace(' ', '_') }}"
  tags:
    - aurora

- name: Ensure that the Aurora /var/run directory exists
  file:
    path: /var/run/aurora
    state: directory
    recurse: yes
    mode: 0775
  tags:
    - aurora

- name: Ensure that the Aurora bin directory exists
  file:
    path: "{{ aurora_bin_dir }}/{{ safe_aurora_cluster_name }}"
    state: directory
    recurse: yes
  tags:
    - aurora

- name: Ensure that the Aurora log directory exists
  file:
    path: "{{ aurora_log_dir }}/{{ safe_aurora_cluster_name }}"
    state: directory
    recurse: yes
  tags:
    - aurora

- name: Ensure that the Aurora lib directory exists
  file:
    path: "{{ aurora_lib_dir }}/{{ aurora_version }}"
    state: directory
    recurse: yes
  tags:
    - aurora

- name: Ensure that the Aurora configuration directory exists
  file:
    path: "{{ aurora_conf_dir }}/{{ safe_aurora_cluster_name }}"
    state: directory
    recurse: yes
  tags:
    - aurora

- name: Ensure that the Aurora state directory exists
  file:
    path: "{{ aurora_state_dir }}/{{ safe_aurora_cluster_name }}"
    state: directory
    recurse: yes
  tags:
    - aurora

- name: Download Aurora scheduler
  get_url:
    url: "{{ aurora_mirror_base }}/{{ aurora_version }}/aurora-scheduler-{{ aurora_version }}.zip"
    dest: "{{ aurora_lib_dir }}/{{ aurora_version }}/aurora.zip"
  register: aurora_download
  tags:
    - aurora

- name: Unzip Aurora archive
  unarchive:
    src: "{{ aurora_lib_dir }}/{{ aurora_version }}/aurora.zip"
    dest: "{{ aurora_lib_dir }}/{{ aurora_version }}"
  when: aurora_download.changed
  tags:
    - aurora

- name: Template Mesos ZooKeeper quorum file
  template:
    src: zk.j2
    dest: "{{ aurora_conf_dir }}/{{ safe_aurora_cluster_name }}/zk"
  tags:
    - aurora
    - aurora_config

- name: Template Aurora cluster-specific startup script
  template:
    src: aurora-startup.sh.j2
    dest: "{{ aurora_bin_dir }}/{{ safe_aurora_cluster_name }}/startup"
    mode: 0755
  tags:
    - aurora
    - aurora_config

- name: Template Aurora cluster-specific init script
  template:
    src: aurora-control.sh.j2
    dest: "{{ aurora_bin_dir }}/{{ safe_aurora_cluster_name }}/control"
    mode: 0755
  tags:
    - aurora
    - aurora_config

- name: Setup a site-specific Aurora Monit configuration
  template:
    src: aurora.monit.j2
    dest: "/etc/monit.d/aurora-scheduler"
  notify:
    - Reload Monit
  tags:
    - aurora
